{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <h2 class="mb-4 text-center">Admin Dashboard</h2>

  <!-- Alerts -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Lecturer Assignment Section -->
  <div class="card shadow p-4 mb-4">
    <h4 class="mb-3">Assign Lecturer to Faculty, Department, Course, and Module</h4>
    <form method="POST" action="{{ url_for('admin_bp.assign_lecturer') }}">
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="lecturer_id" class="form-label">Select Lecturer</label>
          <select class="form-select" name="lecturer_id" id="lecturer_id" required>
            <option value="">-- Select Lecturer --</option>
            {% for lecturer in lecturers %}
              <option value="{{ lecturer.id }}">{{ lecturer.full_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label for="faculty_id" class="form-label">Select Faculty</label>
          <select class="form-select" name="faculty_id" id="faculty_id" required>
            <option value="">-- Select Faculty --</option>
            {% for faculty in faculties %}
              <option value="{{ faculty.id }}">{{ faculty.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label for="department_id" class="form-label">Select Department</label>
          <select class="form-select" name="department_id" id="department_id" required>
            <option value="">-- Select Department --</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="course_id" class="form-label">Select Course</label>
          <select class="form-select" name="course_id" id="course_id" required>
            <option value="">-- Select Course --</option>
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <label for="module_id" class="form-label">Select Module</label>
          <select class="form-select" name="module_id" id="module_id" required>
            <option value="">-- Select Module --</option>
          </select>
        </div>

        <div class="col-md-6 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Assign Lecturer</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Current Assignments Section -->
  <div class="card shadow p-4">
    <h4 class="mb-3">Current Lecturer Assignments</h4>
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Lecturer</th>
          <th>Faculty</th>
          <th>Department</th>
          <th>Course</th>
          <th>Module</th>
          <th>Assigned On</th>
        </tr>
      </thead>
      <tbody>
        {% for assignment in assignments %}
        <tr>
          <td>{{ assignment.lecturer.full_name }}</td>
          <td>{{ assignment.faculty.name }}</td>
          <td>{{ assignment.department.name }}</td>
          <td>{{ assignment.course.name }}</td>
          <td>{{ assignment.module.name }}</td>
          <td>{{ assignment.assigned_at.strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center">No lecturer assignments yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const facultySelect = document.getElementById("faculty_id");
    const departmentSelect = document.getElementById("department_id");
    const courseSelect = document.getElementById("course_id");
    const moduleSelect = document.getElementById("module_id");

    facultySelect.addEventListener("change", function() {
        const facultyId = this.value;
        departmentSelect.innerHTML = '<option value="">-- Select Department --</option>';
        courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
        moduleSelect.innerHTML = '<option value="">-- Select Module --</option>';
        if (!facultyId) return;

        fetch(`/admin/get_departments/${facultyId}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(d => {
                    const option = document.createElement("option");
                    option.value = d.id;
                    option.textContent = d.name;
                    departmentSelect.appendChild(option);
                });
            });
    });

    departmentSelect.addEventListener("change", function() {
        const departmentId = this.value;
        courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
        moduleSelect.innerHTML = '<option value="">-- Select Module --</option>';
        if (!departmentId) return;

        fetch(`/admin/get_courses/${departmentId}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(c => {
                    const option = document.createElement("option");
                    option.value = c.id;
                    option.textContent = c.name;
                    courseSelect.appendChild(option);
                });
            });
    });

    courseSelect.addEventListener("change", function() {
        const courseId = this.value;
        moduleSelect.innerHTML = '<option value="">-- Select Module --</option>';
        if (!courseId) return;

        fetch(`/admin/get_modules/${courseId}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(m => {
                    const option = document.createElement("option");
                    option.value = m.id;
                    option.textContent = m.name;
                    moduleSelect.appendChild(option);
                });
            });
    });
});
</script>
{% endblock %}
