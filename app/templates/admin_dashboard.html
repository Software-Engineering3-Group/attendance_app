<!-- templates/admin_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #222;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background: #007bff;
            color: white;
        }
        tr:nth-child(even) {
            background: #f2f2f2;
        }
        select, button {
            padding: 6px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .remove-link {
            color: red;
            font-size: 13px;
            text-decoration: none;
        }
        .remove-link:hover {
            text-decoration: underline;
        }
        .no-modules {
            color: #777;
        }
    </style>
</head>

<body>
    <h1>Welcome, {{ admin.full_name }}</h1>
    <h2>Registered Lecturers</h2>

    <table>
        <thead>
            <tr>
                <th>Lecturer</th>
                <th>Faculty</th>
                <th>Department</th>
                <th>Assigned Modules</th>
                <th>Assign Module</th>
            </tr>
        </thead>
        <tbody>
            {% for lecturer in lecturers %}
            <tr>
                <td>{{ lecturer.user.full_name }}</td>
                <td>{{ lecturer.department.faculty.name if lecturer.department and lecturer.department.faculty else '-' }}</td>
                <td>{{ lecturer.department.name if lecturer.department else '-' }}</td>

                <!-- Assigned Modules -->
                <td>
                    {% set assigned_modules = [] %}
                    {% for assignment in assignments %}
                        {% if assignment.lecturer_id == lecturer.id %}
                            {% set _ = assigned_modules.append(assignment.module.name) %}
                            <span>{{ assignment.module.name }}</span>
                            <a href="{{ url_for('admin_bp.remove_assignment', assignment_id=assignment.id) }}" class="remove-link">[Remove]</a><br>
                        {% endif %}
                    {% endfor %}
                    {% if not assigned_modules %}
                        <span class="no-modules">No modules assigned</span>
                    {% endif %}
                </td>

                <!-- Assign Module Form -->
                <td>
                    <form action="{{ url_for('admin_bp.assign_lecturer') }}" method="POST">
                        <input type="hidden" name="lecturer_id" value="{{ lecturer.id }}">
                        
                        <select name="faculty_id" class="faculty-dropdown" required>
                            <option value="">Select Faculty</option>
                            {% for faculty in faculties %}
                                <option value="{{ faculty.id }}">{{ faculty.name }}</option>
                            {% endfor %}
                        </select>

                        <select name="department_id" class="department-dropdown" required>
                            <option value="">Select Department</option>
                        </select>

                        <select name="module_id" class="module-dropdown" required>
                            <option value="">Select Module</option>
                        </select>

                        <button type="submit">Assign</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

<script>
$(document).ready(function() {
    // Load Departments when Faculty changes
    $('.faculty-dropdown').change(function() {
        let facultyId = $(this).val();
        let row = $(this).closest('tr');
        let deptDropdown = row.find('.department-dropdown');
        let moduleDropdown = row.find('.module-dropdown');

        deptDropdown.html('<option>Loading...</option>');
        moduleDropdown.html('<option value="">Select Module</option>');

        if (facultyId) {
            $.getJSON(`/admin/get_departments/${facultyId}`, function(data) {
                let options = '<option value="">Select Department</option>';
                if (data.length > 0) {
                    $.each(data, function(i, d) {
                        options += `<option value="${d.id}">${d.name}</option>`;
                    });
                } else {
                    options = '<option>No departments found</option>';
                }
                deptDropdown.html(options);
            });
        } else {
            deptDropdown.html('<option value="">Select Department</option>');
        }
    });

    // Load Modules when Department changes
    $('.department-dropdown').change(function() {
        let departmentId = $(this).val();
        let row = $(this).closest('tr');
        let moduleDropdown = row.find('.module-dropdown');

        moduleDropdown.html('<option>Loading...</option>');

        if (departmentId) {
            $.getJSON(`/admin/get_modules/${departmentId}`, function(data) {
                let options = '<option value="">Select Module</option>';
                if (data.length > 0) {
                    $.each(data, function(i, m) {
                        options += `<option value="${m.id}">${m.name}</option>`;
                    });
                } else {
                    options = '<option>No modules found</option>';
                }
                moduleDropdown.html(options);
            });
        } else {
            moduleDropdown.html('<option value="">Select Module</option>');
        }
    });
});
</script>

</body>
</html>
